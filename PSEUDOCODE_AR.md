# الكود الزائف - واجهة برمجة تطبيقات عيادة العيون

## 1. تهيئة الخادم

```
دالة main()
    تحميل متغيرات البيئة من .env
    إنشاء تطبيق Express
    تكوين برنامج CORS الوسيط
    تكوين تسجيل الطلبات (morgan)
    تكوين محلل JSON (الحد: 10MB)
    تكوين محلل URL-encoded
    تكوين مجموعة أحرف UTF-8 لاستجابات JSON
    تكوين تحديد المعدل (100 طلب/15 دقيقة)
    إعداد توثيق Swagger
    ربط جميع وحدات المسارات
    تسجيل معالجات الأخطاء
    بدء الخادم على المنفذ (الافتراضي: 5000)
نهاية الدالة
```

## 2. اتصال قاعدة البيانات

```
دالة createConnectionPool()
    إنشاء مجموعة اتصالات MySQL مع:
        - host, user, password, database
        - connectionLimit: 10
        - charset: utf8mb4
    اختبار الاتصال
    تعيين متغيرات جلسة UTF-8
    إرجاع pool
نهاية الدالة

دالة getConnection()
    الحصول على اتصال من pool
    إرجاع الاتصال
نهاية الدالة
```

## 3. المصادقة

```
دالة registerClinic(clinicData, ownerData)
    بدء المعاملة
        التحقق من الحقول المطلوبة
        التحقق من وجود البريد الإلكتروني
        إنشاء رمز العيادة
        إدراج العيادة في قاعدة البيانات
        تشفير كلمة مرور المالك باستخدام bcrypt
        إدراج المالك كمسؤول
        تحديث العيادة بـ owner_id
    تأكيد المعاملة
    إنشاء رمز JWT
    إرجاع {token, user, clinic}
نهاية الدالة

دالة login(email, password)
    البحث عن المستخدم بالبريد الإلكتروني
    إذا لم يتم العثور على المستخدم إذن
        إرجاع خطأ: "بيانات اعتماد غير صحيحة"
    نهاية إذا
    مقارنة كلمة المرور مع كلمة المرور المشفرة
    إذا كانت كلمة المرور غير صحيحة إذن
        إرجاع خطأ: "بيانات اعتماد غير صحيحة"
    نهاية إذا
    إنشاء رمز JWT
    إرجاع {token, user}
نهاية الدالة

دالة authenticateToken(request)
    استخراج الرمز من رأس Authorization
    إذا لم يتم توفير الرمز إذن
        إرجاع 401 Unauthorized
    نهاية إذا
    التحقق من رمز JWT بالمفتاح السري
    إذا كان الرمز غير صالح إذن
        إرجاع 403 Forbidden
    نهاية إذا
    إرفاق بيانات المستخدم بالطلب
    المتابعة إلى البرنامج الوسيط التالي
نهاية الدالة
```

## 4. إدارة العيادات

```
دالة getAllClinics()
    استعلام قاعدة البيانات عن جميع العيادات النشطة
    إرجاع قائمة العيادات
نهاية الدالة

دالة getClinicById(clinicId)
    استعلام قاعدة البيانات عن العيادة بالمعرف
    إذا لم يتم العثور على العيادة إذن
        إرجاع 404 Not Found
    نهاية إذا
    إرجاع بيانات العيادة
نهاية الدالة

دالة createClinic(clinicData)
    التحقق من صحة بيانات العيادة
    إنشاء رمز العيادة
    إدراج العيادة في قاعدة البيانات
    إرجاع العيادة المنشأة
نهاية الدالة

دالة updateClinic(clinicId, clinicData)
    التحقق من وجود العيادة
    تحديث العيادة في قاعدة البيانات
    إرجاع العيادة المحدثة
نهاية الدالة

دالة deleteClinic(clinicId)
    التحقق من وجود العيادة
    حذف العيادة بشكل ناعم (تعيين status = 'inactive')
    إرجاع رسالة نجاح
نهاية الدالة
```

## 5. إدارة المستخدمين

```
دالة getAllUsers(clinicId)
    استعلام قاعدة البيانات عن المستخدمين في العيادة
    تصفية حسب الدور إذا تم تحديده
    إرجاع قائمة المستخدمين
نهاية الدالة

دالة createUser(userData)
    التحقق من صحة بيانات المستخدم
    التحقق من وجود البريد الإلكتروني
    تشفير كلمة المرور
    إدراج المستخدم في قاعدة البيانات
    إرجاع المستخدم المنشأ
نهاية الدالة

دالة updateUser(userId, userData)
    التحقق من وجود المستخدم
    إذا تم توفير كلمة المرور إذن
        تشفير كلمة المرور الجديدة
    نهاية إذا
    تحديث المستخدم في قاعدة البيانات
    إرجاع المستخدم المحدث
نهاية الدالة

دالة deleteUser(userId)
    التحقق من وجود المستخدم
    حذف المستخدم بشكل ناعم
    إرجاع رسالة نجاح
نهاية الدالة
```

## 6. إدارة المرضى

```
دالة getAllPatients(clinicId, filters)
    بناء استعلام مع المرشحات (الاسم، الهاتف، الحالة)
    استعلام قاعدة البيانات عن المرضى
    إرجاع قائمة المرضى مع التصفح
نهاية الدالة

دالة getPatientById(patientId)
    استعلام قاعدة البيانات عن المريض بالمعرف
    تضمين السجل الطبي
    إرجاع بيانات المريض
نهاية الدالة

دالة createPatient(patientData)
    التحقق من صحة بيانات المريض
    التحقق من وجود الهاتف/البريد الإلكتروني
    إدراج المريض في قاعدة البيانات
    إرجاع المريض المنشأ
نهاية الدالة

دالة updatePatient(patientId, patientData)
    التحقق من وجود المريض
    تحديث المريض في قاعدة البيانات
    إرجاع المريض المحدث
نهاية الدالة
```

## 7. إدارة الأطباء

```
دالة getAllDoctors(clinicId)
    استعلام قاعدة البيانات عن الأطباء في العيادة
    تضمين معلومات الجدول
    إرجاع قائمة الأطباء
نهاية الدالة

دالة getDoctorById(doctorId)
    استعلام قاعدة البيانات عن الطبيب بالمعرف
    تضمين عدد المواعيد
    إرجاع بيانات الطبيب
نهاية الدالة

دالة createDoctor(doctorData)
    التحقق من صحة بيانات الطبيب
    إنشاء حساب مستخدم للطبيب
    إدراج الطبيب في قاعدة البيانات
    إرجاع الطبيب المنشأ
نهاية الدالة

دالة updateDoctorSchedule(doctorId, schedule)
    تحديث جدول الطبيب في قاعدة البيانات
    إرجاع الجدول المحدث
نهاية الدالة
```

## 8. إدارة المواعيد

```
دالة createAppointment(appointmentData)
    التحقق من صحة بيانات الموعد
    التحقق من توفر الطبيب
    التحقق من وجود المريض
    التحقق من توفر الفترة الزمنية
    إدراج الموعد في قاعدة البيانات
    إرسال إشعار للمريض
    إرجاع الموعد المنشأ
نهاية الدالة

دالة getAllAppointments(clinicId, filters)
    بناء استعلام مع المرشحات (التاريخ، الطبيب، الحالة)
    استعلام قاعدة البيانات عن المواعيد
    إرجاع قائمة المواعيد
نهاية الدالة

دالة updateAppointmentStatus(appointmentId, status)
    التحقق من وجود الموعد
    تحديث حالة الموعد
    إذا كانت الحالة = 'completed' إذن
        إنشاء إدخال سجل طبي
    نهاية إذا
    إرجاع الموعد المحدث
نهاية الدالة

دالة cancelAppointment(appointmentId, reason)
    التحقق من وجود الموعد
    تحديث حالة الموعد إلى 'cancelled'
    إرسال إشعار الإلغاء
    إرجاع رسالة نجاح
نهاية الدالة
```

## 9. إدارة اختبارات الألوان

```
دالة submitTestAnswers(token, answers)
    التحقق من رمز المصادقة
    التحقق من صحة مصفوفة الإجابات
    حساب نتيجة الاختبار
    تحديد نوع عمى الألوان
    إدراج نتائج الاختبار في قاعدة البيانات
    إرجاع ملخص الاختبار
نهاية الدالة

دالة getPatientTests(patientId)
    استعلام قاعدة البيانات عن اختبارات المريض
    ترتيب حسب التاريخ تنازلياً
    إرجاع قائمة الاختبارات
نهاية الدالة

دالة getTestById(testId)
    استعلام قاعدة البيانات عن الاختبار بالمعرف
    تضمين الإجابات التفصيلية
    إرجاع بيانات الاختبار
نهاية الدالة
```

## 10. إدارة الوصفات

```
دالة createPrescription(prescriptionData)
    التحقق من صحة بيانات الوصفة
    التحقق من وجود الموعد
    إدراج الوصفة في قاعدة البيانات
    إرجاع الوصفة المنشأة
نهاية الدالة

دالة getPatientPrescriptions(patientId)
    استعلام قاعدة البيانات عن وصفات المريض
    تضمين تفاصيل الأدوية
    إرجاع قائمة الوصفات
نهاية الدالة

دالة updatePrescription(prescriptionId, data)
    التحقق من وجود الوصفة
    تحديث الوصفة في قاعدة البيانات
    إرجاع الوصفة المحدثة
نهاية الدالة
```

## 11. التقارير الطبية

```
دالة createMedicalReport(reportData)
    التحقق من صحة بيانات التقرير
    التحقق من وجود الموعد
    إدراج التقرير في قاعدة البيانات
    إرجاع التقرير المنشأ
نهاية الدالة

دالة getPatientReports(patientId)
    استعلام قاعدة البيانات عن تقارير المريض
    ترتيب حسب التاريخ تنازلياً
    إرجاع قائمة التقارير
نهاية الدالة

دالة getReportById(reportId)
    استعلام قاعدة البيانات عن التقرير بالمعرف
    إرجاع بيانات التقرير
نهاية الدالة
```

## 12. غرفة الانتظار

```
دالة addToWaitingRoom(patientId, appointmentId)
    التحقق من وجود الموعد
    إدراج في غرفة الانتظار
    تحديث حالة الموعد إلى 'waiting'
    إرجاع إدخال غرفة الانتظار
نهاية الدالة

دالة getWaitingRoom(clinicId)
    استعلام قاعدة البيانات عن المرضى المنتظرين
    ترتيب حسب وقت الوصول
    إرجاع قائمة الانتظار
نهاية الدالة

دالة callNextPatient(clinicId, doctorId)
    الحصول على المريض التالي من غرفة الانتظار
    تحديث حالة الموعد إلى 'in_progress'
    إزالة من غرفة الانتظار
    إرجاع بيانات المريض
نهاية الدالة
```

## 13. التحليلات

```
دالة getDashboardStats(clinicId, dateRange)
    استعلام قاعدة البيانات عن:
        - إجمالي المواعيد
        - المواعيد المكتملة
        - المواعيد المعلقة
        - إجمالي المرضى
        - إجمالي الإيرادات
    حساب الإحصائيات
    إرجاع بيانات لوحة التحكم
نهاية الدالة

دالة getAppointmentsByDate(clinicId, startDate, endDate)
    استعلام قاعدة البيانات عن المواعيد في النطاق الزمني
    تجميع حسب التاريخ
    إرجاع عدد المواعيد لكل يوم
نهاية الدالة

دالة getRevenueReport(clinicId, period)
    استعلام قاعدة البيانات عن المدفوعات في الفترة
    حساب إجمالي الإيرادات
    تجميع حسب التاريخ/الطبيب
    إرجاع تقرير الإيرادات
نهاية الدالة
```

## 14. نقاط نهاية API للمحمول

```
دالة mobileLogin(phone, password)
    البحث عن المريض بالهاتف
    التحقق من كلمة المرور
    إنشاء رمز JWT
    إرجاع {token, patient}
نهاية الدالة

دالة mobileRegister(patientData)
    التحقق من صحة بيانات المريض
    التحقق من وجود الهاتف
    تشفير كلمة المرور
    إدراج المريض في قاعدة البيانات
    إنشاء رمز JWT
    إرجاع {token, patient}
نهاية الدالة

دالة getMobileAppointments(patientId)
    استعلام قاعدة البيانات عن مواعيد المريض
    تضمين معلومات العيادة والطبيب
    إرجاع قائمة المواعيد
نهاية الدالة

دالة bookMobileAppointment(appointmentData)
    التحقق من صحة بيانات الموعد
    التحقق من توفر الطبيب
    إنشاء الموعد
    إرسال إشعار التأكيد
    إرجاع الموعد
نهاية الدالة
```

## 15. معالجة الأخطاء

```
دالة errorHandler(error, request, response, next)
    تسجيل تفاصيل الخطأ
    إذا كان الخطأ خطأ تحقق إذن
        إرجاع 400 Bad Request مع تفاصيل الخطأ
    وإلا إذا كان الخطأ خطأ مصادقة إذن
        إرجاع 401 Unauthorized
    وإلا إذا كان الخطأ خطأ تفويض إذن
        إرجاع 403 Forbidden
    وإلا إذا كان الخطأ غير موجود إذن
        إرجاع 404 Not Found
    وإلا إذا كان الخطأ خطأ قاعدة بيانات إذن
        إرجاع 500 Internal Server Error
    وإلا
        إرجاع 500 مع رسالة خطأ عامة
    نهاية إذا
نهاية الدالة

دالة notFound(request, response)
    إرجاع 404 مع رسالة: "المسار غير موجود"
نهاية الدالة
```

## 16. مساعدات الاستجابة

```
دالة sendSuccess(response, data, message, statusCode)
    إرجاع استجابة JSON:
        {
            success: true,
            message: message,
            data: data
        }
    مع رمز الحالة (الافتراضي: 200)
نهاية الدالة

دالة sendError(response, message, statusCode)
    إرجاع استجابة JSON:
        {
            success: false,
            message: message
        }
    مع رمز الحالة (الافتراضي: 400)
نهاية الدالة
```

## 17. هيكل المسارات

```
المسارات:
    /health → فحص الصحة
    /api/auth → المصادقة (التسجيل، تسجيل الدخول)
    /api/mobile/auth → مصادقة المحمول
    /api/clinics → عمليات CRUD للعيادات
    /api/users → إدارة المستخدمين
    /api/patients → إدارة المرضى
    /api/doctors → إدارة الأطباء
    /api/appointments → إدارة المواعيد
    /api/mobile/appointments → مواعيد المحمول
    /api/prescriptions → إدارة الوصفات
    /api/medical-reports → التقارير الطبية
    /api/test-results → نتائج الاختبارات
    /api/color-tests → إرسال اختبارات الألوان
    /api/mobile/color-tests → اختبارات ألوان المحمول
    /api/waiting-room → إدارة غرفة الانتظار
    /api/analytics → التحليلات والإحصائيات
    /api/reports → التقارير اليومية/الشهرية
```

## 18. تدفق البرامج الوسيطة

```
تدفق الطلب:
    1. برنامج CORS الوسيط
    2. تسجيل الطلبات (morgan)
    3. محلل JSON
    4. محلل URL-encoded
    5. برنامج مجموعة أحرف UTF-8 الوسيط
    6. تحديد المعدل
    7. معالج المسار
    8. معالج الأخطاء (إذا حدث خطأ)
    9. إرسال الاستجابة
```

---

## الملخص

API يتكون من:
1. **التهيئة**: إعداد Express وCORS والبرامج الوسيطة
2. **قاعدة البيانات**: اتصال MySQL مع connection pooling
3. **المصادقة**: رموز JWT للمصادقة والتفويض
4. **عمليات CRUD**: عمليات إنشاء وقراءة وتحديث وحذف لجميع الكيانات
5. **المواعيد**: إدارة المواعيد والجدولة
6. **السجلات الطبية**: الوصفات والتقارير ونتائج الاختبارات
7. **التحليلات**: إحصائيات وتقارير
8. **API للمحمول**: نقاط نهاية مخصصة للتطبيقات المحمولة
9. **معالجة الأخطاء**: معالجة شاملة للأخطاء
10. **الأمان**: تحديد المعدل وCORS ومصادقة JWT
